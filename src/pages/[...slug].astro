---
import { getCollection } from 'astro:content'
import { i18n } from 'i18n'
import client from 'tina/__generated__/client'
import Layout from 'layouts/Layout.astro'
import Page from 'tina/pages/Page'

export async function getStaticPaths() {
    const pages = await getCollection('page')
    const routes = []

    for (const p of pages) {
        const entry = p.id.replace(/^\/|\/$/g, '')
        const [locale, ...segments] = entry.split('/')

        if (locale !== i18n.defaultLocale) continue
        if (segments.length === 0) continue

        if (segments.length === 1 && segments[0] === 'home') continue
        const slugParam = segments.length === 1 ? segments[0] : segments

        routes.push({
            params: { slug: slugParam },
            props: {
                getTinaProps: async () =>
                    client.queries.page({
                        relativePath: p.data.tinaInfo.relativePath,
                    }),
            },
        })
    }

    return routes
}

const locale = i18n.defaultLocale
const { getTinaProps } = Astro.props
const data = await getTinaProps()
---

<Layout locale={locale} title={data.data.page.title} description={data.data.page.description}>
    <Page {...data} client:tina />
</Layout>
